---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(randomForest)
library(ggraph)
library(igraph)
```

```{r}
sessionInfo()
```

```{r}
workingDir <- getwd()
workingDir <- workingDir %>% strsplit(split = "/")
workingDir <- workingDir[[1]][1:6]
workingDir <- paste(
  workingDir[1],
  workingDir[2],
  workingDir[3],
  workingDir[4],
  workingDir[5],
  workingDir[6],
  sep = "/"
  )

workingDir
```

```{r}
df <- read.csv(
  paste(
    workingDir, "data/census/demographics/preprocessed/modelData.csv", sep = "/"
    )
  )

str(df)
```

```{r}
df$party <- df$party %>% sapply(as.factor)
class(df$party)
```

```{r}
for (col in colnames(df)) {
    if (class(df[[col]]) == "integer") {
        df[[col]] <- sapply(df[[col]], as.numeric)
    } 
}

str(df)
```

```{r}
df <- df[, !names(df) %in% c("med_smoc_mort", "med_smoc_no_mort"), drop = F]
colnames(df)
```
```{r}
df[269, "flipped"] <- TRUE
```

```{r}
scale.many <- function(dat, column.nos) {
  nms <- names(dat)
  for(col in column.nos) {
    name <- paste(nms[col],".z", sep = "")
    dat[name] <- scale(dat[,col])
  }
  cat(paste("Scaled ", length(column.nos), " variable(s)\n"))
  dat
}
```

```{r}
to.be.scaled <- 2:(length(colnames(df)) - 2)
dfScaled <- df %>% mutate_at(to.be.scaled, ~(scale(.) %>% as.vector))

row.names(dfScaled) <- dfScaled$districtDemographics
dfScaled <- dfScaled[
  , !names(dfScaled) %in% c("districtDemographics", "flipped"), drop = F
  ]

dfScaled
```

```{r}
Democrat   <- length((dfScaled %>% subset(party == "D"))$party)
Republican <- length((dfScaled %>% subset(party == "R"))$party)

baseline <- (Democrat / (Democrat + Republican)) * 100

sprintf("Baseline Accuracy: %.2f percent", baseline)
```

```{r}
set.seed(42)
sample <- caTools::sample.split(dfScaled$party, SplitRatio = 0.8)

train <- subset(dfScaled, sample == TRUE)
test  <- subset(dfScaled, sample == FALSE)

print(glue::glue("({length(train$party)}, {length(test$party)})"))
```

```{r}
head(train)
```


```{r}
head(test)
```

```{r}
set.seed(42)
model <- randomForest(party ~ ., data = train)
model
```

```{r}
trainPreds <- data.frame(
  predicted = model$predicted, actual = train$party
  )

testPreds <- model %>% predict(test %>% select(1:65))

testPreds <- data.frame(
  predicted = testPreds, actual = test$party
  )

testCM <- yardstick::conf_mat(
  testPreds, truth = actual, estimate = predicted
  )

testCM
```

```{r}
summary(testCM)
```


```{r}
preds <- bind_rows(trainPreds, testPreds) %>%
  select(predicted, actual)

head(preds)
```

```{r}
varImpPlot(model, n.var = 10, main = "Party Affiliation Model")
```

```{r}
varImportances <- importance(model)
topTen <- varImportances[varImportances > 4, ] %>% sort(decreasing = TRUE)

topTen
```

```{r}
importanceModel <- randomForest(
  party ~ walking_public_transit +
    renter_occupied +
    natural_born_citizen +
    car +
    owner_occupied +
    foreign_born +
    white +
    asian +
    other_race +
    med_rent,
  data = train
)

importanceModel
```

```{r}
trainImportance <- data.frame(
  predicted = importanceModel$predicted, actual = train$party
  )

testImportance <- importanceModel %>% predict(test %>% select(1:65))

testImportance <- data.frame(
  predicted = testImportance, actual = test$party
  )

importanceCM <- yardstick::conf_mat(
  testImportance, truth = actual, estimate = predicted
  )

importanceCM
```

```{r}
summary(importanceCM)
```

source: [https://shiring.github.io/machine_learning/2017/03/16/rf_plot_ggraph]

```{r}
tree_func <- function(final_model, 
                      tree_num) {
  
  # get tree by index
  tree <- randomForest::getTree(final_model, 
                                k = tree_num, 
                                labelVar = TRUE) %>%
    tibble::rownames_to_column() %>%
    # make leaf split points to NA, so the 0s won't get plotted
    mutate(`split point` = ifelse(is.na(prediction), `split point`, NA))
  
  # prepare data frame for graph
  graph_frame <- data.frame(from = rep(tree$rowname, 2),
                            to = c(tree$`left daughter`, tree$`right daughter`))
  
  # convert to graph and delete the last node that we don't want to plot
  graph <- graph_from_data_frame(graph_frame) %>%
    delete_vertices("0")
  
  # set node labels
  V(graph)$node_label <- gsub("_", " ", as.character(tree$`split var`))
  V(graph)$leaf_label <- as.character(tree$prediction)
  V(graph)$split <- as.character(round(tree$`split point`, digits = 2))
  
  # plot
  plot <- ggraph(graph, 'dendrogram') + 
    theme_bw() +
    geom_edge_link() +
    geom_node_point() +
    geom_node_text(aes(label = node_label), na.rm = TRUE, repel = TRUE) +
    geom_node_label(aes(label = split), vjust = 2.5, na.rm = TRUE, fill = "white") +
    geom_node_label(aes(label = leaf_label, fill = leaf_label), na.rm = TRUE, 
					repel = TRUE, colour = "white", fontface = "bold", show.legend = FALSE) +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.background = element_blank(),
          plot.background = element_rect(fill = "white"),
          panel.border = element_blank(),
          axis.line = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          plot.title = element_text(size = 18))
  
  print(plot)
}
```

```{r}
treeNum <- which(model$forest$ndbigtree == min(model$forest$ndbigtree))
tree_func(final_model = model, tree_num = treeNum)
```

```{r}
treeNum <- which(
  importanceModel$forest$ndbigtree == min(importanceModel$forest$ndbigtree)
  )

tree_func(final_model = importanceModel, tree_num = treeNum)
```